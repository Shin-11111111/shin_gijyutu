<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI レポート採点</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .json-block {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 1.25rem;
            border-radius: 0.75rem;
            font-family: 'Fira Code', 'Courier New', Courier, monospace;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 0.875rem;
            border: 1px solid #333;
        }
        .step-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.2s;
        }
        .step-card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tab-active {
            border-bottom: 2px solid #10b981;
            color: #10b981;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">
    <div class="max-w-6xl mx-auto py-8 px-4 md:px-8">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700 tracking-tight mb-2">AIレポート採点</h1>
        </header>

        <!-- Top Sections: Configuration & Rubric -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8 items-stretch">
            
            <!-- Left Side: Step 1 & 2 container -->
            <div class="flex flex-col gap-6">
                <!-- Step 1: Template -->
                <section class="step-card border-l-4 border-l-amber-400">
                    <h2 class="flex items-center text-lg font-bold mb-3">
                        STEP 1: データの準備
                    </h2>
                    <p class="text-sm text-slate-600 mb-4">
                        【番号,名前,レポート】の形式でデータを入力します。
                    </p>
                    <button onclick="downloadTemplate()" class="w-full bg-amber-50 text-amber-700 border border-amber-200 hover:bg-amber-100 font-semibold py-2 px-4 rounded-lg transition flex items-center justify-center">
                        テンプレートのダウンロード
                    </button>
                </section>

                <!-- Step 2: Config -->
                <section class="step-card border-l-4 border-l-indigo-500 flex-grow">
                    <h2 class="flex items-center text-lg font-bold mb-4">
                        STEP 2: 設定・入力
                    </h2>
                    <div class="space-y-4">
                        <!-- API Key -->
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <label class="block text-xs font-bold text-slate-500 uppercase">API Key の入力</label>
                                <a href="https://aistudio.google.com/" target="_blank" rel="noopener noreferrer" class="text-[10px] text-indigo-600 hover:text-indigo-800 font-bold flex items-center">
                                    Gemini API の取得
                                </a>
                            </div>
                            <input type="password" id="apiKey" class="w-full p-2.5 bg-indigo-50 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Gemini API Key">
                        </div>

                        <!-- Subject & Theme (Added fields) -->
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">科目名</label>
                                <input type="text" id="subjectName" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="教科名(+単元名)">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">レポートのテーマ</label>
                                <input type="text" id="reportTheme" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="何についてのレポートかを入力">
                            </div>
                        </div>

                        <!-- Max Score -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">項目の満点 (記述式用)</label>
                            <input type="number" id="maxScore" value="10" min="1" class="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>

                        <!-- Target CSV -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">採点対象のCSV</label>
                            <div class="p-3 bg-indigo-50 border border-indigo-200 rounded-xl">
                                <input type="file" id="csvFile" accept=".csv" class="w-full text-xs text-slate-500 file:mr-2 file:py-2 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 cursor-pointer">
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Side: Step 3 (Rubric) -->
            <section class="step-card border-l-4 border-l-emerald-500 flex flex-col">
                <h2 class="flex items-center text-lg font-bold mb-4">
                    STEP 3: 評価規準の設定
                </h2>

                <!-- Tabs -->
                <div class="flex border-b border-slate-200 mb-4">
                    <button id="tabText" onclick="switchTab('text')" class="flex-1 py-2 text-sm font-bold tab-active">記述式</button>
                    <button id="tabRubric" onclick="switchTab('rubric')" class="flex-1 py-2 text-sm font-bold text-slate-400">ルーブリック形式</button>
                </div>
                
                <div class="flex-grow">
                    <!-- Text Area Input -->
                    <div id="textInputArea" class="block space-y-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">評価規準(結果が点数で出ます)</label>
                        <textarea id="rubricText" class="w-full h-48 md:h-55 p-4 bg-emerald-50 border border-emerald-200 rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none transition resize-none" 
                            placeholder="文章や箇条書きなどで入力してください。"></textarea>
                    </div>

                    <!-- Rubric Table Input -->
                    <div id="rubricInputArea" class="hidden space-y-3">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">評価規準(結果が A+ ～ C- で出ます)</label>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="flex items-center gap-2">
                                <span class="w-10 text-xs font-bold text-emerald-700">A+</span>
                                <input type="text" id="rubric-ap" class="flex-1 p-2 bg-emerald-50 border border-emerald-100 rounded text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="達成率90%以上">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-10 text-xs font-bold text-emerald-600">A</span>
                                <input type="text" id="rubric-a" class="flex-1 p-2 bg-emerald-50 border border-emerald-100 rounded text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="達成率80%以上90%未満">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-10 text-xs font-bold text-emerald-500">B</span>
                                <input type="text" id="rubric-b" class="flex-1 p-2 bg-emerald-50 border border-emerald-100 rounded text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="達成率50%以上80%未満">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-10 text-xs font-bold text-emerald-400">C</span>
                                <input type="text" id="rubric-c" class="flex-1 p-2 bg-emerald-50 border border-emerald-100 rounded text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="達成率20%以上50%未満">
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-10 text-xs font-bold text-emerald-300">C-</span>
                                <input type="text" id="rubric-cm" class="flex-1 p-2 bg-emerald-50 border border-emerald-100 rounded text-sm focus:outline-none focus:ring-1 focus:ring-emerald-500" placeholder="達成率20%未満">
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-slate-50 border border-dashed border-slate-300 rounded-xl">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">
                            ● 採点済みサンプルの学習 (任意)
                        </label>
                        <p class="text-xs text-slate-450 mb-4">
                            採点の参考にできます。
                        </p>
                        <input type="file" id="referenceCsvFile" accept=".csv" class="w-full text-xs text-slate-500 file:mr-3 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="startGrading()" id="startBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-12 rounded-xl transition shadow-lg shadow-emerald-200 flex items-center justify-center">
                        採点開始
                    </button>
                </div>
            </section>
        </div>

        <!-- Progress Box -->
        <div id="statusBox" class="hidden mb-8 p-4 rounded-xl text-center font-medium"></div>

        <!-- Result Section -->
        <div class="w-full">
            <section id="resultSection" class="step-card border-l-4 border-l-slate-800"> <!-- hidden なし-->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-xl font-bold">採点結果</h2>
                        <p class="text-[10px] text-slate-500">最後は必ず目を通して評価に反映させてください。</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="downloadCSV()" id="downloadCsvBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2.5 px-6 rounded-lg transition shadow-md">
                            CSV保存
                        </button>
                        <button onclick="downloadJSON()" class="bg-slate-700 hover:bg-slate-800 text-white text-sm font-bold py-2.5 px-6 rounded-lg transition shadow-md">
                            JSON保存
                        </button>
                    </div>
                </div>
                <div id="jsonOutput" class="json-block min-h-[200px]"></div>
            </section>
        </div>
        <p class="text-xs text-slate-400 text-center mt-12">【免責事項】本サイトは働き方改革での利用を目的としています。AIの回答によって生じたいかなる損害についても作成者は責任を負いません。</p>
    </div>

    <script type="module">
        let finalResults = [];
        let originalCsvData = [];
        let currentMode = 'text';

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Tab Switching
        window.switchTab = (mode) => {
            currentMode = mode;
            // クラスの付け替え
            document.getElementById('tabText').className = `flex-1 py-2 text-sm font-bold ${mode === 'text' ? 'tab-active' : 'text-slate-400'}`;
            document.getElementById('tabRubric').className = `flex-1 py-2 text-sm font-bold ${mode === 'rubric' ? 'tab-active' : 'text-slate-400'}`;
            
            document.getElementById('textInputArea').classList.toggle('hidden', mode === 'rubric');
            document.getElementById('rubricInputArea').classList.toggle('hidden', mode === 'text');
        };

        window.downloadTemplate = () => {
            const content = "番号,名前,レポート";
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "report_template.csv";
            link.click();
        };

        async function fetchWithRetry(url, options, retries = 3, backoff = 2000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Detail:", errorData); // エラー内容をコンソールに表示
                    if (response.status === 429 && retries > 0) {
                        await sleep(backoff);
                        return fetchWithRetry(url, options, retries - 1, backoff * 2);
                    }
                    throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                }
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    await sleep(backoff);
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        const parseCSV = (text) => {
            return text.split(/\r?\n/)
                .filter(row => row.trim() !== "")
                .map(row => row.split(',').map(c => c.trim().replace(/^"|"$/g, '')));
        };

        window.startGrading = async () => {
            const apiKey = document.getElementById('apiKey').value.trim();
            const rubricText = document.getElementById('rubricText').value;
            const subjectName = document.getElementById('subjectName').value;
            const reportTheme = document.getElementById('reportTheme').value;
            const maxScore = document.getElementById('maxScore').value || 10;
            const fileInput = document.getElementById('csvFile');
            const referenceInput = document.getElementById('referenceCsvFile');
            const startBtn = document.getElementById('startBtn');
            const statusBox = document.getElementById('statusBox');
            const resultSection = document.getElementById('resultSection');
            const jsonOutput = document.getElementById('jsonOutput');

            const rubrics = {
                ap: document.getElementById('rubric-ap').value,
                a: document.getElementById('rubric-a').value,
                b: document.getElementById('rubric-b').value,
                c: document.getElementById('rubric-c').value,
                cm: document.getElementById('rubric-cm').value
            };

            const isRubricFilled = Object.values(rubrics).some(v => v.trim() !== "");
            const isTextFilled = rubricText.trim() !== "";

            if (!apiKey) return alert("APIキーを入力してください");
            if (!fileInput.files[0]) return alert("CSVファイルを選択してください");
            if (!isTextFilled && !isRubricFilled) return alert("評価規準を入力してください");

            startBtn.disabled = true;
            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
            startBtn.textContent = "準備中...";
            statusBox.className = "p-4 rounded-xl bg-blue-50 text-blue-700 block text-center animate-pulse mb-8";
            statusBox.textContent = "データを解析しています...";
            
            finalResults = [];
            originalCsvData = [];

            let finalRubricPrompt = "";
            const subjectContext = subjectName ? `科目: ${subjectName}\n` : "";
            const themeContext = reportTheme ? `レポートのテーマ: ${reportTheme}\n` : "";

            if (currentMode === 'rubric' && isRubricFilled) {
                finalRubricPrompt = `
                ${subjectContext}${themeContext}
                以下の5段階ルーブリックに基づいて評価してください：
                - A+: ${rubrics.ap || "評価規準の90%以上満たしている(十分満足できると判断されるもののうち、特に高い程度のもの)"}
                - A : ${rubrics.a || "評価規準の80%以上90%未満である(十分満足できると判断されるもの)"}
                - B : ${rubrics.b || "評価規準の50%以上80%未満である(おおむね満足と判断されるもの)"}
                - C : ${rubrics.c || "評価規準の20%以上50%未満である(努力を要すると判断されるもの)"}
                - C-: ${rubrics.cm || "評価規準の20%未満である(一層努力を要すると判断されるもの)"}
                評価は必ずこの5つのいずれか（A+, A, B, C, C-）を total_score に含めてください。
                `;
            } else {
                finalRubricPrompt = `${subjectContext}${themeContext}評価規準: ${rubricText}\n満点: ${maxScore}点`;
            }

            let referenceContext = "";
            if (referenceInput.files[0]) {
                try {
                    const refText = await referenceInput.files[0].text();
                    const refRows = parseCSV(refText);
                    const refData = refRows.slice(1).filter(r => r.length >= 4);
                    if (refData.length > 0) {
                        referenceContext = "\n参考例:\n" + refData.slice(0, 5).map(r => `レポート: ${r[2]}\n評価: ${r[3]}`).join("\n---\n");
                    }
                } catch (e) { console.error("参考CSVの読み込み失敗", e); }
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = parseCSV(text);
                let startIndex = (rows[0].includes("レポート") || rows[0].includes("名前") || rows[0].includes("番号")) ? 1 : 0;
                const dataRows = rows.slice(startIndex).filter(r => r.length >= 2);

                for (let i = 0; i < dataRows.length; i++) {
                    const columns = dataRows[i];
                    originalCsvData.push(columns);
                    statusBox.textContent = `進捗: ${i + 1} / ${dataRows.length} 件目を処理中... (${columns[1] || 'No Name'})`;

                    const systemPrompt = `あなたは公平な教員です。指定された科目・テーマ・評価規準に従い、レポートを評価してJSON形式で出力してください。
                    【注意点】
                    - 評価は甘すぎず厳しすぎず、学校評価として妥当な基準で行ってください。また、文章の内容のみを評価対象としてください。
                    - 同じ条件のレポートであれば、常に同じ点数になるように判断してください。
                    - 文章が一般論に終始している場合や、不自然に整いすぎている部分があれば指摘してください。ただし、AI使用や不正行為の断定は絶対に行わないでください。
                    - この評価結果を、教師が保護者・生徒に説明しても問題ない内容にしてください。
                    【出力形式】
                    {"total_score": "点数または評価", "overall_comment": "評価の根拠(満点以外なら減点理由を必ず書く)、良かった点、改善点(「何を・どこに・どう直すか」を具体的に示す)"}
                    
                    【評価規準】
                    ${finalRubricPrompt}
                    ${referenceContext}`;
                    
                    const userPrompt = `【レポート本文】\n${columns[2] || "（本文なし）"}`;

                    try {
                        const url = "https://generativeai.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + apiKey;
                        const response = await fetchWithRetry(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{ text: systemPrompt + "\n\n" + userPrompt }]
                                }],
                                // generationConfig: {
                                //     response_mime_type: "application/json"
                                // }
                            })
                        });

                        const resText = response.candidates[0].content.parts[0].text;
                        const parsedItem = JSON.parse(resText);

                        finalResults.push({ 
                            index: i,
                            student_info: { id: columns[0], name: columns[1] }, 
                            evaluation: parsedItem 
                        });

                        jsonOutput.textContent = JSON.stringify(finalResults, null, 2);

                    } catch (error) {
                        console.error(error);
                        finalResults.push({ index: i, student_info: { id: columns[0], name: columns[1] }, error: error.message });
                    }
                    await sleep(1000); // 連続リクエストによる負荷軽減
                }

                statusBox.className = "p-4 rounded-xl bg-green-50 text-green-700 block text-center font-bold mb-8";
                statusBox.textContent = "評価が完了しました！";
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                startBtn.textContent = "採点開始";
            };
            reader.readAsText(fileInput.files[0]);
        };

        window.downloadCSV = () => {
            let csvContent = "番号,名前,レポート,評価結果,フィードバック\n";
            originalCsvData.forEach((row, idx) => {
                const res = finalResults.find(r => r.index === idx);
                const score = res?.evaluation?.total_score || (res?.error ? "Error" : "");
                const comment = res?.evaluation?.overall_comment || res?.error || "";
                const escaped = [...row.slice(0,3), score, comment].map(v => `"${(v || "").toString().replace(/"/g, '""')}"`);
                csvContent += escaped.join(",") + "\n";
            });
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "graded_reports.csv";
            link.click();
        };

        window.downloadJSON = () => {
            const blob = new Blob([JSON.stringify(finalResults, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "grading_results.json";
            link.click();
        };
    </script>
</body>
</html>