<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レジシステム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントを設定 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        #app-container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background: white;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
        }
        /* サイドバー (縦型タブ) */
        #sidebar {
            width: 200px; 
            background-color: #1f2937; /* Dark Gray */
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }
        /* メインコンテンツエリア */
        #main-content {
            flex-grow: 1;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }
        /* タブボタンのスタイル */
        .tab-button {
            display: flex;
            align-items: center;
            padding: 12px 16px; 
            margin: 4px 12px; 
            color: #d1d5db; /* Gray 300 */
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
            border-radius: 8px;
        }
        .tab-button:hover {
            background-color: #374151; /* Gray 700 */
            color: white;
        }
        .tab-button.active-tab {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        /* 商品ボタンのカスタムスタイル */
        .product-button {
            transition: transform 0.1s, background-color 0.1s;
            background-color: #eef2ff; /* Indigo 50 */
            color: #1f2937; 
            border: 1px solid #c7d2fe; /* Indigo 200 */
        }
        .product-button:hover {
            background-color: #e0e7ff; /* Indigo 100 */
        }
        .product-button:active {
            transform: scale(0.98);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* 電卓ボタンのカスタムスタイル */
        .calc-button {
            height: 64px;
            font-size: 2rem;
            font-weight: 300;
            transition: background-color 0.1s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .calc-button:active {
            box-shadow: none;
            transform: translateY(1px);
        }
        
        /* モバイルでの調整 */
        @media (max-width: 767px) {
            body { padding: 0; }
            #app-container {
                height: 100vh;
                border-radius: 0;
                flex-direction: column;
                max-width: 100%;
            }
            #sidebar {
                width: 100%;
                height: 56px;
                padding: 0;
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                border-bottom: 1px solid #374151;
            }
            .tab-button {
                flex-direction: column;
                padding: 4px 8px;
                margin: 0;
                border-radius: 0;
                color: #9ca3af; 
                background-color: transparent;
                font-size: 0.75rem;
            }
            .tab-button.active-tab {
                background-color: transparent;
                color: #4f46e5; 
                border-bottom: 2px solid #4f46e5;
                box-shadow: none;
            }
            .tab-button:hover { background-color: transparent; }
            .tab-button svg { margin-bottom: 2px; margin-right: 0 !important; width: 20px; height: 20px; }
            
            /* レジ画面のレイアウトを縦型に強制 */
            .tab-content[data-content="pos"] { flex-direction: column; }
            .tab-content[data-content="pos"] > div { height: 50%; width: 100% !important; }
            #menu-area { border-bottom: 1px solid #e5e7eb; }
            #register-area { border-left: none !important; border-top: 1px solid #e5e7eb; }
        }
        .truncate {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-gray-100 p-0 md:p-8">

    <div id="app-container" class="transition-all duration-300">
        
        <!-- 縦型タブ (サイドバー) -->
        <div id="sidebar">
            <h1 class="text-white text-xl font-extrabold mb-6 px-3 text-center hidden md:block">POS System</h1>
            <!-- タブ切り替えボタン -->
            <button data-tab="pos" onclick="switchTab('pos')" class="tab-button active-tab">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m4 0h6a2 2 0 002-2v-3m-6 3l-6-6m-2 2l4 4m6 0l4-4"></path></svg>
                <span class="hidden md:inline">レジ</span>
                <span class="inline md:hidden">レジ</span>
            </button>
            <button data-tab="settings" onclick="switchTab('settings')" class="tab-button">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <span class="hidden md:inline">設定</span>
                <span class="inline md:hidden">設定</span>
            </button>
            <button data-tab="history" onclick="switchTab('history')" class="tab-button">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <span class="hidden md:inline">販売履歴</span>
                <span class="inline md:hidden">履歴</span>
            </button>
             <button data-tab="calculator" onclick="switchTab('calculator')" class="tab-button">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 16l-4-4m0 0l4-4m-4 4h14m-5 4h5a2 2 0 002-2v-5a2 2 0 00-2-2H9m-4 4h4"></path></svg>
                <span class="hidden md:inline">電卓</span>
                <span class="inline md:hidden">電卓</span>
            </button>
        </div>

        <!-- メインコンテンツ (タブ内容) -->
        <div id="main-content">
            
            <!-- 1. レジ画面 (POS) タブ -->
            <div data-content="pos" class="tab-content w-full h-full flex active-content">
                <!-- 1.1. メニュー (左側) -->
                <div id="menu-area" class="w-3/5 p-4 md:p-6 flex flex-col h-full overflow-hidden">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">商品メニュー</h2>
                    <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 flex-grow overflow-y-auto no-scrollbar pb-4">
                        <div class="text-center p-8 bg-gray-100 rounded-lg text-gray-500 col-span-full">メニューを読み込み中...</div>
                    </div>
                </div>

                <!-- 1.2. レジ/カート (右側) -->
                <div id="register-area" class="w-2/5 p-4 md:p-6 bg-gray-50 flex flex-col h-full border-l border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">カート</h2>
                    
                    <!-- カートアイテムリスト -->
                    <div id="cart-list-container" class="flex-grow overflow-y-auto no-scrollbar mb-4 border-b border-gray-200">
                        <ul id="cart-list" class="space-y-2"></ul>
                        <div id="empty-cart-message" class="text-center py-12 text-gray-400">カートは空です</div>
                    </div>

                    <!-- 合計金額と割引 -->
                    <div class="space-y-2 text-lg font-medium mb-4">
                        <div class="flex justify-between text-gray-600">
                            <span>小計:</span>
                            <span id="subtotal-display">¥0</span>
                        </div>
                        <div class="flex justify-between items-center text-red-500">
                            <label for="discount-input" class="cursor-pointer">
                                <span class="mr-2">割引:</span>
                                <span class="text-sm text-gray-500 hidden md:inline">(¥ or %)</span>
                            </label>
                            <input type="text" id="discount-input" value="" placeholder="例:100 or 10%" 
                                oninput="updateCart()"
                                class="w-32 text-right p-1 text-red-500 border border-red-300 rounded-lg focus:ring-red-500 focus:border-red-500 font-bold">
                        </div>
                        <div class="flex justify-between text-red-500 text-base font-semibold">
                            <span>割引額:</span>
                            <span id="discount-display">- ¥0</span>
                        </div>
                        <div class="flex justify-between text-3xl font-extrabold text-gray-900 border-t pt-2 mt-2">
                            <span>合計:</span>
                            <span id="total-display">¥0</span>
                        </div>
                    </div>

                    <!-- アクションボタン -->
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="clearCart()" class="action-button bg-red-500 hover:bg-red-600 text-white font-semibold py-4 rounded-xl shadow-lg transition duration-150">
                            <span class="text-xl">取消</span>
                        </button>
                        <button onclick="showPaymentModal()" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 rounded-xl shadow-lg transition duration-150" id="payment-button" disabled>
                            <span class="text-xl">会計</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. 設定タブ (商品編集 + 支払い方法編集) -->
            <div data-content="settings" class="tab-content w-full h-full p-4 md:p-6 flex flex-col hidden overflow-y-auto no-scrollbar">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">アプリケーション設定・管理</h3>

                <!-- 2.1 支払い方法の管理 (新しいセクション) -->
                <div class="p-4 mb-6 bg-green-50 rounded-xl shadow-md border border-green-200">
                    <h4 class="text-lg font-bold mb-3 text-green-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        支払い方法の管理
                    </h4>
                    <div id="payment-methods-list" class="flex flex-wrap gap-2 mb-3">
                        <!-- 支払い方法タグがここに描画されます -->
                        <span class="text-sm text-gray-500">支払い方法を読み込み中...</span>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <input type="text" id="new-payment-method-name" placeholder="新しい支払い方法名" class="col-span-3 p-3 border rounded-lg focus:ring-green-500 focus:border-green-500">
                        <button onclick="addPaymentMethod()" class="action-button col-span-1 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md">
                            追加
                        </button>
                    </div>
                </div>
                
                <!-- 2.2. 商品追加フォーム -->
                <div class="p-4 mb-6 bg-indigo-50 rounded-xl shadow-md border border-indigo-200">
                    <h4 class="text-lg font-bold mb-3 text-indigo-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        新しい商品を追加
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                        <input type="text" id="new-item-name" placeholder="商品名" class="col-span-2 p-3 border rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="number" id="new-item-price" placeholder="価格 (例: 300)" min="0" class="col-span-1 p-3 border rounded-lg text-right focus:ring-indigo-500 focus:border-indigo-500">
                        <button onclick="addNewItem()" class="action-button col-span-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md">
                            追加
                        </button>
                    </div>
                </div>

                <!-- 2.3. 編集リスト -->
                <div class="flex-grow overflow-y-auto no-scrollbar">
                    <h4 class="text-lg font-bold mb-3 text-gray-700 border-b pb-2">すでに追加されている商品の編集</h4>
                    <ul id="edit-list" class="space-y-3">
                        <!-- ヘッダー -->
                        <li class="hidden md:grid grid-cols-7 gap-4 text-sm font-semibold text-gray-500 border-b pb-2 px-2">
                            <span class="col-span-3">商品名</span>
                            <span class="col-span-1 text-right">価格</span>
                            <span class="col-span-1 text-center">メニュー表示</span>
                            <span class="col-span-2 text-center">削除</span>
                        </li>
                        <li class="text-center py-8 text-gray-500">アイテムを読み込み中...</li>
                    </ul>
                </div>
            </div>

            <!-- 3. 販売履歴タブ (フル幅) -->
            <div data-content="history" class="tab-content w-full h-full p-4 md:p-6 flex flex-col hidden overflow-y-auto no-scrollbar">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">販売履歴</h3>

                <div class="mb-4 flex justify-end">
                    <button onclick="confirmResetOthersResetHistory()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        本日以外の販売履歴をリセット
                    </button>
                    <button onclick="confirmResetHistory()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        販売履歴をリセット
                    </button>
                </div>

                <div id="history-stats" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">本日の来場者数 (会計回数)</p>
                        <p id="stats-visitors" class="text-3xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border border-gray-100">
                        <p class="text-sm font-medium text-gray-500">本日の総売上</p>
                        <p id="stats-revenue" class="text-3xl font-bold text-green-600">¥0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow border border-gray-100 cursor-pointer hover:bg-gray-50"> <p class="text-sm font-medium text-gray-500">本日の商品別販売個数</p>
                        <p id="stats-items-count" class="text-xl font-bold text-gray-800 overflow-hidden truncate">読み込み中...</p><p id="stats-item-detail-message" class="text-xs text-indigo-500 mt-1">詳細はタップして表示</p>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto no-scrollbar bg-gray-50 p-4 rounded-lg shadow-inner">
                    <ul id="history-list" class="space-y-4">
                        <li class="text-center py-8 text-gray-500">履歴を読み込み中...</li>
                    </ul>
                </div>
            </div>
            
            <!-- 4. 電卓タブ (フル幅) -->
            <div data-content="calculator" class="tab-content w-full h-full p-4 md:p-6 flex flex-col hidden">
                <h3 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-3">電卓</h3>
                <div class="flex-grow flex items-center justify-center">
                    <div class="w-full max-w-sm p-4 bg-white rounded-xl shadow-2xl">
                        <!-- 電卓ディスプレイ -->
                        <div id="calc-display" class="bg-gray-800 text-white text-right p-4 rounded-lg text-6xl font-light mb-4 overflow-hidden" style="min-height: 80px;">0</div>
                        
                        <!-- ボタン -->
                        <div id="calc-buttons" class="grid grid-cols-4 gap-3">
                            <!-- AC, +/-, %, ÷ -->
                            <button class="calc-button bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full" onclick="calcAction('clear')">AC</button>
                            <button class="calc-button bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full" onclick="calcAction('toggleSign')">+/-</button>
                            <button class="calc-button bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full" onclick="calcAction('operator', '%')">%</button>
                            <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white rounded-full" onclick="calcAction('operator', '/')">÷</button>

                            <!-- 7, 8, 9, × -->
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '7')">7</button>
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '8')">8</button>
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '9')">9</button>
                            <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white rounded-full" onclick="calcAction('operator', '*')">×</button>

                            <!-- 4, 5, 6, - -->
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '4')">4</button>
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '5')">5</button>
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '6')">6</button>
                            <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white rounded-full" onclick="calcAction('operator', '-')">-</button>

                            <!-- 1, 2, 3, + -->
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '1')">1</button>
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '2')">2</button>
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('digit', '3')">3</button>
                            <button class="calc-button bg-orange-500 hover:bg-orange-600 text-white rounded-full" onclick="calcAction('operator', '+')">+</button>

                            <!-- 0, ., = -->
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full col-span-2" onclick="calcAction('digit', '0')">0</button>
                            <button class="calc-button bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full" onclick="calcAction('decimal', '.')">.</button>
                            <button class="calc-button bg-orange-600 hover:bg-orange-700 text-white rounded-full" onclick="calcAction('calculate', '=')">=</button>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- ステータスとUser ID表示 -->
        <div class="w-full bg-white border-t border-gray-200 p-2 flex justify-between text-xs text-gray-500 absolute bottom-0 max-w-[1200px] md:max-w-none">
            <span id="status-message">初期化中...</span>
        </div>
    </div>

    <!-- 支払いモーダル -->
    <div id="payment-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all">
            <h3 class="text-2xl font-bold mb-4">会計</h3>

            <div class="mb-4 text-center">
                <p class="text-lg text-gray-600">お支払い合計</p>
                <p id="modal-total-display" class="text-5xl font-extrabold text-indigo-600">¥0</p>
            </div>
            
            <!-- 支払い方法選択 (動的に更新される) -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">支払い方法</label>
                <select id="payment-method-select" class="block w-full p-3 border border-gray-300 rounded-lg bg-white text-lg"
                        onchange="updatePaymentStatus()">
                    <!-- JSでオプションを追加 -->
                </select>
            </div>

            <!-- 入力された金額 -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">お預かり金額 (現金の場合のみ変更可能)</label>
                <input type="number" id="cash-tendered-input" value="0" min="0" class="mt-1 block w-full text-3xl p-3 border border-gray-300 rounded-lg text-right focus:ring-indigo-500 focus:border-indigo-500"
                       oninput="updateChange()">
            </div>

            <!-- お釣り表示 -->
            <div class="flex justify-between items-center bg-yellow-50 p-3 rounded-lg border border-yellow-200 mb-6">
                <span class="text-lg font-semibold text-gray-700">お釣り:</span>
                <span id="change-display" class="text-3xl font-extrabold text-green-600">¥0</span>
            </div>


            <div class="grid grid-cols-2 gap-3">
                <button onclick="hidePaymentModal()" class="action-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-xl">
                    キャンセル
                </button>
                <button onclick="processPayment()" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl" id="complete-payment-button" disabled>
                    完了
                </button>
            </div>
        </div>
    </div>
    
    <!-- メッセージボックス -->
    <div id="message-box" class="fixed bottom-4 right-4 bg-gray-800 text-white p-4 rounded-lg shadow-2xl z-50 hidden transition-opacity duration-300 opacity-0 max-w-xs">
        <p id="message-text" class="font-medium"></p>
    </div>

    <div id="item-stats-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-lg transform transition-all">
            <h3 class="text-2xl font-bold mb-4 border-b pb-2">商品別 販売個数一覧</h3>

            <div class="max-h-96 overflow-y-auto mb-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                商品名
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                販売個数
                            </th>
                        </tr>
                    </thead>
                    <tbody id="item-stats-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>

            <button onclick="hideItemStatsModal()" class="action-button w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl">
                閉じる
            </button>
        </div>
    </div>

    <script type="module">
        // 新しいグローバル変数
        window.inventory = [];
        window.cart = [];
        window.paymentMethods = ["現金", "二次元コード決済", "クレジットカード", "その他"];
        window.dbInitialized = true; // DB接続は不要なので常にtrueとする

        // ローカルストレージキー
        const LS_KEYS = {
            MENU: 'pos_menu_items',
            HISTORY: 'pos_sales_history',
            PAYMENT: 'pos_payment_methods'
        };
        // --- ローカルストレージ ユーティリティ関数 ---

        // データをローカルストレージから読み込む
        const loadFromLocalStorage = (key, defaultValue) => {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error(`Error loading from LS key: ${key}`, e);
                return defaultValue;
            }
        };

        // データをローカルストレージに保存する
        const saveToLocalStorage = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving to LS key: ${key}`, e);
            }
        };

        // 一意なIDを生成するシンプルな関数
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 5);


        // --- ユーティリティ関数 ---
        const formatYen = (amount) => `¥${Math.max(0, Math.floor(amount)).toLocaleString()}`;

        const showMessage = (message) => {
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            text.textContent = message;
            box.classList.remove('hidden', 'opacity-0');
            box.classList.add('opacity-100');
            
            clearTimeout(window.messageTimer);
            
            window.messageTimer = setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        };

        // --- タブ切り替えロジック ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
                if (content.getAttribute('data-content') === tabName) {
                    content.classList.remove('hidden');
                    if (tabName === 'history') window.renderHistoryList();
                    if (tabName === 'settings') {
                         window.renderEditList(); 
                         window.renderPaymentEditSection();
                    }
                }
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active-tab');
                if (button.getAttribute('data-tab') === tabName) {
                    button.classList.add('active-tab');
                }
            });
            
            if (window.innerWidth < 768) {
                document.getElementById('main-content').scrollIntoView({ behavior: 'smooth' });
            }
        };
        
        window.addEventListener('load', () => window.switchTab('pos'));


        // --- メニュー描画ロジック ---
        window.renderMenu = () => {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';

            if (inventory.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500 bg-white rounded-lg">メニューアイテムがありません。「設定」タブから追加してください。</div>';
                return;
            }

            inventory.filter(item => !item.isHidden).forEach(item => {
                const button = document.createElement('button');
                button.className = 'product-button p-4 rounded-xl shadow-md flex flex-col justify-center items-center text-center';
                button.innerHTML = `
                    <span class="text-xl font-semibold">${item.name}</span>
                    <span class="text-sm text-gray-600">${formatYen(item.price)}</span>
                `;
                button.onclick = () => addToCart(item); 
                grid.appendChild(button);
            });
        };

        // --- カートロジック (POSタブ) ---
        const addToCart = (item) => {
            const existingItem = cart.find(cartItem => cartItem.docId === item.docId); 
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    docId: item.docId,
                    name: item.name,
                    price: item.price,
                    quantity: 1
                });
            }
            showMessage(`${item.name} を追加しました`);
            updateCart();
        };
        
        const updateQuantity = (docId, change) => {
            const itemIndex = cart.findIndex(item => item.docId === docId);
            if (itemIndex > -1) {
                const item = cart[itemIndex];
                item.quantity += change;
                if (item.quantity <= 0) {
                    cart.splice(itemIndex, 1);
                }
            }
            updateCart();
        };

        const calculateDiscount = (subtotal) => {
            const input = document.getElementById('discount-input').value.trim();
            if (!input) return 0;

            const percentMatch = input.match(/^(\d+(\.\d+)?)%$/);
            if (percentMatch) {
                const percentage = parseFloat(percentMatch[1]);
                if (isNaN(percentage)) return 0;
                return Math.min(subtotal, Math.round(subtotal * (percentage / 100)));
            }

            const yenValue = parseInt(input.replace(/[^0-9]/g, ''), 10);
            if (!isNaN(yenValue) && yenValue > 0) {
                return Math.min(subtotal, yenValue);
            }

            return 0;
        };

        const updateCart = () => {
            const cartListElement = document.getElementById('cart-list');
            const emptyMessage = document.getElementById('empty-cart-message');
            const paymentButton = document.getElementById('payment-button');
            const discountDisplay = document.getElementById('discount-display');
            
            cartListElement.innerHTML = '';
            
            let subtotal = 0;
            
            if (cart.length === 0) {
                emptyMessage.classList.remove('hidden');
                paymentButton.disabled = true;
            } else {
                emptyMessage.classList.add('hidden');
                paymentButton.disabled = false;
                
                cart.forEach(item => {
                    const lineTotal = item.quantity * item.price;
                    subtotal += lineTotal;
                    
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100';
                    li.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <span class="font-medium text-gray-800 truncate">${item.name}</span>
                            <span class="block text-xs text-gray-500">${formatYen(item.price)} x ${item.quantity}</span>
                        </div>
                        <div class="font-semibold text-lg text-gray-900 mr-4">${formatYen(lineTotal)}</div>
                        <div class="flex space-x-1">
                            <button onclick="updateQuantity('${item.docId}', 1)" class="text-blue-500 hover:text-blue-700 p-1 rounded-full bg-blue-50 h-7 w-7 flex items-center justify-center text-sm font-bold">+</button>
                            <button onclick="updateQuantity('${item.docId}', -1)" class="text-red-500 hover:text-red-700 p-1 rounded-full bg-red-50 h-7 w-7 flex items-center justify-center text-sm font-bold">-</button>
                        </div>
                    `;
                    cartListElement.appendChild(li);
                });
            }

            const discountAmount = calculateDiscount(subtotal);
            const total = subtotal - discountAmount;

            document.getElementById('subtotal-display').textContent = formatYen(subtotal);
            if (discountDisplay) {
                discountDisplay.textContent = `- ${formatYen(discountAmount)}`;
            }
            document.getElementById('total-display').textContent = formatYen(total);
            
            window.currentTotal = total;
            window.currentSubtotal = subtotal;
            window.currentDiscount = discountAmount;
        };
        
        const clearCart = () => {
            if (cart.length > 0 || window.currentDiscount > 0) {
                cart = [];
                document.getElementById('discount-input').value = '0';
                updateCart();
                showMessage('カートをクリアしました');
            } else {
                showMessage('カートはすでに空です');
            }
        };


        // --- 支払いモーダルロジック ---
        const showPaymentModal = () => {
            if (window.currentTotal <= 0) {
                showMessage('合計金額が0円以下です。会計できません。');
                return;
            }
            if (cart.length === 0) return;

            const modal = document.getElementById('payment-modal');
            const totalDisplay = document.getElementById('modal-total-display');
            const methodSelect = document.getElementById('payment-method-select');
            
            // 支払い方法リストを最新の状態で描画
            methodSelect.innerHTML = window.paymentMethods.map(method => 
                `<option value="${method}">${method}</option>`
            ).join('');
            
            totalDisplay.textContent = formatYen(window.currentTotal);
            document.getElementById('cash-tendered-input').value = window.currentTotal;

            updateChange();
            updatePaymentStatus();

            modal.classList.remove('hidden');
        };

        const hidePaymentModal = () => {
            document.getElementById('payment-modal').classList.add('hidden');
        };
        
        const updateChange = () => {
            const inputElement = document.getElementById('cash-tendered-input');
            const changeDisplay = document.getElementById('change-display');
            const total = window.currentTotal;
            const tendered = parseInt(inputElement.value || 0);
            
            const change = tendered - total;
            
            changeDisplay.textContent = formatYen(change);
            changeDisplay.classList.toggle('text-red-600', change < 0);
            changeDisplay.classList.toggle('text-green-600', change >= 0);
        };

        const updatePaymentStatus = () => {
            const methodSelect = document.getElementById('payment-method-select');
            const tenderedInput = document.getElementById('cash-tendered-input');
            const completeButton = document.getElementById('complete-payment-button');
            const total = window.currentTotal;
            const selectedMethod = methodSelect.value;
            
            if (total <= 0) {
                completeButton.disabled = true;
                return;
            }

            // 「現金」の場合のみお預かり金額のチェックが必要
            if (selectedMethod === "現金") {
                const tendered = parseInt(tenderedInput.value || 0);
                completeButton.disabled = tendered < total;
            } else {
                completeButton.disabled = false;
            }
            
            tenderedInput.disabled = (selectedMethod !== "現金");
        };

        const processPayment = () => {
            const methodSelect = document.getElementById('payment-method-select');
            const tenderedInput = document.getElementById('cash-tendered-input');
            
            const selectedMethod = methodSelect.value;
            const total = window.currentTotal;
            // 現金以外の場合は合計金額をお預かり金額とする
            const tendered = selectedMethod === "現金" ? parseInt(tenderedInput.value || 0) : total;
            const change = tendered - total;

            const saleData = {
                timestamp: new Date().toISOString(),
                // total, subtotal, discount は既にグローバル変数に保持されている
                total: total, // 修正: totalを使用
                subtotal: window.currentSubtotal,
                discount: window.currentDiscount,
                
                // 上記で定義した変数を使用
                method: selectedMethod,
                tendered: tendered,
                change: change,
                
                items: cart.map(item => ({
                    docId: item.docId, 
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                saleId: generateId() // 履歴IDを追加
            };

            try {
                // DB通信の代わりにローカルストレージに保存
                const history = loadFromLocalStorage(LS_KEYS.HISTORY, []);
                history.push(saleData);
                saveToLocalStorage(LS_KEYS.HISTORY, history);
                
                showMessage(`会計完了: ${formatYen(window.currentTotal)}を記録しました (${selectedMethod})`);
            } catch (e) {
                console.error("Failed to save sale history locally:", e);
                showMessage(`エラー: 履歴の保存に失敗しました`);
            }

            hidePaymentModal();
            clearCart();
            window.renderHistoryList(); // 履歴リストを更新
        };

        // --- 履歴描画ロジック (Historyタブ) ---
        window.renderHistoryList = () => {
            const historyList = document.getElementById('history-list');
            // 初期メッセージをセット
            historyList.innerHTML = '<li class="text-center py-8 text-gray-500">履歴を読み込み中...</li>';

            try {
                // DB通信の代わりにローカルストレージから取得
                let historyData = loadFromLocalStorage(LS_KEYS.HISTORY, []);

                // タイムスタンプの新しい順にソート
                historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // ----------------------------------------------------
                // ↓↓↓ [追加] 統計情報集計ロジック ↓↓↓
                // ----------------------------------------------------
                const today = new Date().toLocaleDateString('ja-JP');
                let dailyRevenue = 0;
                let todayItemCounts = {}; // 変数名を変更して、今日の商品個数であることを明確化
                let todayVisitors = 0;    // 変数名を変更して、今日の来場者数であることを明確化
                
                historyData.forEach(sale => {
                    const saleDate = new Date(sale.timestamp).toLocaleDateString('ja-JP');
                    
                    if (saleDate === today) {
                        // '今日'のデータのみをカウント・集計
                        todayVisitors++; // 今日の来場者数のみカウント
                        dailyRevenue += sale.total;
                        
                        sale.items.forEach(item => {
                            todayItemCounts[item.name] = (todayItemCounts[item.name] || 0) + item.quantity; // ★修正2: 今日売れた商品のみ集計
                        });
                    }
                });
                
                // 集計結果をグローバルに保存 (モーダル表示用)
                window.currentItemCounts = todayItemCounts; // グローバル変数を今日のデータで更新

                // 集計結果の表示更新
                document.getElementById('stats-visitors').textContent = todayVisitors.toLocaleString(); // ★修正3: 今日の来場者数を表示
                document.getElementById('stats-revenue').textContent = formatYen(dailyRevenue);
                
                // 商品別販売個数の表示を生成 (上位3つを表示)
                const sortedItems = Object.entries(todayItemCounts) // ★修正4: 今日の商品集計データを使用
                    .sort(([, a], [, b]) => b - a)
                    .map(([name, count]) => `${name}: ${count}個`);
                
                const itemStatsText = sortedItems.length > 0 
                    ? sortedItems.slice(0, 3).join(' / ') + (sortedItems.length > 3 ? ' ...' : '')
                    : 'なし';

                const statsItemsCountElement = document.getElementById('stats-items-count');
                statsItemsCountElement.textContent = itemStatsText;
                
                // ★ クリックでモーダルを表示するイベントを設定 ★
                const itemStatsContainer = statsItemsCountElement.closest('.bg-white');
                if (itemStatsContainer) {
                    itemStatsContainer.onclick = showItemStatsModal;
                    itemStatsContainer.classList.add('cursor-pointer', 'hover:bg-gray-50');
                }

                // ----------------------------------------------------
                // ↑↑↑ 統計情報集計ロジック ↑↑↑
                // ----------------------------------------------------

                let listHtml = '';

                if (historyData.length === 0) {
                    // 履歴がない場合のメッセージ
                    listHtml = '<li class="text-center py-8 text-gray-400">まだ販売履歴はありません。</li>';
                } else {
                    // 履歴がある場合の描画ロジック
                    listHtml = historyData.map(sale => {
                        const dateTime = new Date(sale.timestamp);
                        const dateStr = dateTime.toLocaleDateString('ja-JP');
                        const timeStr = dateTime.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        
                        // 販売アイテム詳細を文字列化
                        const itemsDetail = sale.items.map(item => 
                            `${item.name} x ${item.quantity} (${formatYen(item.price * item.quantity)})`
                        ).join(', ');

                        return `
                            <li class="bg-white p-4 rounded-lg shadow border border-gray-100">
                                <div class="flex justify-between items-center border-b pb-2 mb-2">
                                    <div class="text-sm text-gray-600">
                                        <span class="font-semibold">${dateStr} ${timeStr}</span> 
                                        <span class="text-xs text-gray-400 block sm:inline"> (ID: ${sale.saleId.substring(0, 8)}...)</span>
                                    </div>
                                    <span class="text-lg font-bold text-indigo-600">${formatYen(sale.total)}</span>
                                </div>
                                <div class="text-sm text-gray-700 space-y-1">
                                    <p><strong>支払い:</strong> ${sale.method} &bull; <strong>小計:</strong> ${formatYen(sale.subtotal)} &bull; <strong>割引:</strong> ${formatYen(sale.discount)}</p>
                                    <p class="truncate"><strong>内訳:</strong> ${itemsDetail}</p>
                                    <p class="text-xs text-gray-500"><strong>お預かり/お釣り:</strong> ${formatYen(sale.tendered)} / ${formatYen(sale.change)}</p>
                                </div>
                            </li>
                        `;
                    }).join('');
                }
                
                // 最終的なHTMLをリストに反映 (読み込み中メッセージを上書き)
                historyList.innerHTML = listHtml;
                
            } catch (e) {
                console.error("Failed to fetch history locally:", e);
                // エラー時の表示
                historyList.innerHTML = `<li class="text-center py-8 text-red-500">履歴の取得エラー: ${e.message}</li>`;
            }
        };
        
        // --- 履歴リセットロジック ---
        
        /**
         * 履歴リセットの確認ダイアログを表示
         */
        const confirmResetHistory = () => {
            if (confirm("【警告】 全ての販売履歴を完全に削除します。この操作は元に戻せません。よろしいですか？")) {
                resetHistory();
            }
        };

        /**
         * 履歴をリセット（削除）する
         */
        const resetHistory = () => {
            try {
                // ローカルストレージから履歴キーを削除
                localStorage.removeItem(LS_KEYS.HISTORY);
                
                // 履歴リストの再描画（空になる）
                window.renderHistoryList(); 
                
                // 成功メッセージ
                showMessage('全ての販売履歴がリセットされました');
            } catch (e) {
                console.error("Failed to reset history locally:", e);
                showMessage(`エラー: 履歴のリセットに失敗しました`);
            }
        };

        // 新しいヘルパー関数（一部履歴削除機能、ここ？）
        const filterHistoryByDate = (historyData, dateToKeep) => {
            // 保持したい日付（今日）と一致するデータのみをフィルタリング
            return historyData.filter(sale => {
                const saleDate = new Date(sale.timestamp).toLocaleDateString('ja-JP');
                return saleDate === dateToKeep;
            });
        };

        // 今日以外の履歴をリセットするための確認処理
        const confirmResetOthersResetHistory = () => {
            if (confirm("【警告】今日以外の販売履歴を完全に削除します。この操作は元に戻せません。よろしいですか？")) {
                resetOthersResetHistory();
            }
        };

        // 今日以外の履歴をリセットする処理
        const resetOthersResetHistory = () => {
            try {
                let historyData = loadFromLocalStorage(LS_KEYS.HISTORY, []);
                
                // 今日の日付を取得 (日本ローカル形式)
                const today = new Date().toLocaleDateString('ja-JP');

                // 今日のデータのみを抽出
                const todayHistory = filterHistoryByDate(historyData, today);
                
                // 今日のデータのみを保存し直す
                saveToLocalStorage(LS_KEYS.HISTORY, todayHistory);
                
                // 履歴リストを再描画
                renderHistoryList();
                
                alert(`今日 (${today}) の販売履歴 ${todayHistory.length} 件を残し、それ以外の履歴を削除しました。`);
            } catch (e) {
                console.error('履歴のクリア中にエラーが発生しました:', e);
                alert('エラー：履歴のクリアに失敗しました。');
            }
        };

        /**
         * 商品別販売個数モーダルを表示
         */
        const showItemStatsModal = () => {
            const modal = document.getElementById('item-stats-modal');
            const tableBody = document.getElementById('item-stats-table-body');
            
            tableBody.innerHTML = ''; // テーブルをクリア

            const itemCounts = window.currentItemCounts || {};
            const sortedItems = Object.entries(itemCounts)
                .sort(([, a], [, b]) => b - a); // 個数で降順ソート
            
            if (sortedItems.length === 0) {
                 tableBody.innerHTML = `
                    <tr>
                        <td colspan="2" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            販売履歴がありません。
                        </td>
                    </tr>
                `;
            } else {
                sortedItems.forEach(([name, count]) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate">${name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right font-bold">${count.toLocaleString()} 個</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            modal.classList.remove('hidden');
        };

        /**
         * 商品別販売個数モーダルを非表示
         */
        const hideItemStatsModal = () => {
            document.getElementById('item-stats-modal').classList.add('hidden');
        };

        // --- 商品編集ロジック (Settingsタブ) ---
        window.renderEditList = () => {
            const editList = document.getElementById('edit-list');
            const header = editList.querySelector('li:first-child');
            editList.innerHTML = '';
            if (header) { editList.appendChild(header); }

            if (inventory.length === 0) {
                 editList.insertAdjacentHTML('beforeend', '<li class="text-center py-8 text-gray-500">メニューアイテムがありません。上部のフォームから追加してください。</li>');
                return;
            }

            inventory.forEach(item => {
                const li = document.createElement('li');
                li.className = 'grid grid-cols-7 gap-4 items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200';
                li.innerHTML = `
                    <input type="text" id="edit-name-${item.docId}" value="${item.name}" 
                           class="col-span-3 p-2 border rounded text-sm w-full" placeholder="商品名" 
                           onchange="updateItem('${item.docId}')">
                    <input type="number" id="edit-price-${item.docId}" value="${item.price}" 
                           class="col-span-1 p-2 border rounded text-sm w-full text-right" placeholder="価格" min="0" 
                           onchange="updateItem('${item.docId}')">
                    
                    <div class="col-span-1 flex items-center justify-center">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="edit-hidden-${item.docId}" ${item.isHidden ? '' : 'checked'}
                                   class="sr-only peer" onchange="toggleItemVisibility('${item.docId}', event.target.checked)">
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600 peer-checked:after:translate-x-full peer-checked:after:border-white"></div>
                        </label>
                    </div>
                    
                    <div class="col-span-2 flex justify-center">
                        <button onclick="deleteItem('${item.docId}', '${item.name}')" 
                                class="action-button bg-red-400 hover:bg-red-500 text-white p-2 rounded-full h-8 w-8 flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                editList.appendChild(li);
            });
        };

        const addNewItem = () => {
            const nameInput = document.getElementById('new-item-name');
            const priceInput = document.getElementById('new-item-price');
            const name = nameInput.value.trim();
            const price = parseInt(priceInput.value, 10);

            if (!name || isNaN(price) || price < 0) {
                showMessage('商品名と有効な価格を入力してください');
                return;
            }

            // DB通信の代わりに、ローカルストレージと配列を更新
            const newItem = { docId: generateId(), name: name, price: price, isHidden: false };
            window.inventory.push(newItem);
            saveToLocalStorage(LS_KEYS.MENU, window.inventory); 

            showMessage(`${name} をメニューに追加しました`);
            
            nameInput.value = '';
            priceInput.value = '';
            
            window.renderEditList(); // 編集リストの再描画
            window.renderMenu(); // メニューの再描画
        };

        const updateItem = (docId) => {
            const name = document.getElementById(`edit-name-${docId}`).value.trim();
            const price = parseInt(document.getElementById(`edit-price-${docId}`).value, 10);

            if (!name || isNaN(price) || price < 0) {
                showMessage('有効な名前と価格を入力してください');
                return;
            }

            try {
                // 1. 配列内のアイテムを見つけて更新
                const itemIndex = window.inventory.findIndex(item => item.docId === docId);
                if (itemIndex > -1) {
                    window.inventory[itemIndex].name = name;
                    window.inventory[itemIndex].price = price;
                }
                
                // 2. ローカルストレージに保存
                saveToLocalStorage(LS_KEYS.MENU, window.inventory); 

                showMessage(`${name} の情報を更新しました`);
                window.renderMenu(); // POS画面を更新
            } catch (e) {
                console.error("Failed to update item locally:", e);
                showMessage(`エラー: 商品情報の更新に失敗しました`);
            }
        };

        const toggleItemVisibility = (docId, isChecked) => {
            const newHiddenState = !isChecked;

            try {
                // 1. 配列内のアイテムを見つけて更新
                const itemIndex = window.inventory.findIndex(item => item.docId === docId);
                if (itemIndex > -1) {
                    window.inventory[itemIndex].isHidden = newHiddenState;
                }

                // 2. ローカルストレージに保存
                saveToLocalStorage(LS_KEYS.MENU, window.inventory); 
                
                const itemName = window.inventory[itemIndex]?.name || '商品';
                showMessage(`${itemName} を ${newHiddenState ? '非表示' : '表示'}にしました`);
                window.renderMenu(); // POS画面を更新
            } catch (e) {
                console.error("Failed to toggle visibility locally:", e);
                showMessage(`エラー: 表示設定の更新に失敗しました`);
            }
        };

        const deleteItem = (docId, itemName) => {
            if (!confirm(`本当に「${itemName}」をメニューから削除しますか？`)) { 
                return;
            }

            try {
                // 1. 配列からアイテムを削除
                const initialLength = window.inventory.length;
                window.inventory = window.inventory.filter(item => item.docId !== docId);
                
                if (window.inventory.length < initialLength) {
                    // 2. ローカルストレージに保存
                    saveToLocalStorage(LS_KEYS.MENU, window.inventory); 
                    showMessage(`${itemName} を削除しました`);
                    window.renderEditList(); // 編集リストを更新
                    window.renderMenu(); // POS画面を更新
                } else {
                    showMessage(`エラー: ${itemName}が見つかりませんでした`);
                }
            } catch (e) {
                console.error("Failed to delete item locally:", e);
                showMessage(`エラー: 商品の削除に失敗しました`);
            }
        };

        // --- 支払い方法編集ロジック (Settingsタブ) ---

        window.renderPaymentEditSection = () => {
            const listContainer = document.getElementById('payment-methods-list');
            listContainer.innerHTML = '';

            window.paymentMethods.forEach(method => {
                const badge = document.createElement('span');
                badge.className = 'inline-flex items-center text-sm font-medium px-3 py-1 rounded-full bg-blue-100 text-blue-800 cursor-pointer transition-colors hover:bg-red-100 hover:text-red-800 group';
                badge.innerHTML = `
                    <span>${method}</span>
                    <!-- 削除ボタン -->
                    <button onclick="deletePaymentMethod('${method}')" class="ml-2 -mr-1 h-4 w-4 text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                         <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                listContainer.appendChild(badge);
            });
            
            // 支払いモーダルのselectが現在開いている可能性を考慮して再描画
            const methodSelect = document.getElementById('payment-method-select');
            if(methodSelect) {
                 methodSelect.innerHTML = window.paymentMethods.map(method => 
                    `<option value="${method}">${method}</option>`
                ).join('');
            }
        };

        const addPaymentMethod = () => {
            const nameInput = document.getElementById('new-payment-method-name');
            const newName = nameInput.value.trim();

            if (!newName) {
                showMessage('支払い方法名を入力してください');
                return;
            }

            if (window.paymentMethods.includes(newName)) {
                showMessage('その支払い方法は既に登録されています');
                return;
            }
            
            // DB通信の代わりに、ローカルストレージと配列を更新
            window.paymentMethods.push(newName);
            saveToLocalStorage(LS_KEYS.PAYMENT, window.paymentMethods);

            showMessage(`${newName} を支払い方法に追加しました`);
            nameInput.value = '';
            
            window.renderPaymentEditSection(); // 描画更新
            updatePaymentStatus(); // モーダルの状態を更新
        };

        const deletePaymentMethod = (methodName) => {
            if (!confirm(`本当に「${methodName}」を削除しますか？`)) { 
                return;
            }
            
            if (window.paymentMethods.length <= 1) {
                showMessage('支払い方法は最低1つ必要です。');
                return;
            }

            try {
                // 1. 配列からアイテムを削除
                window.paymentMethods = window.paymentMethods.filter(m => m !== methodName);
                
                // 2. ローカルストレージに保存
                saveToLocalStorage(LS_KEYS.PAYMENT, window.paymentMethods); 

                showMessage(`${methodName} を削除しました`);
                window.renderPaymentEditSection(); // 描画更新
                updatePaymentStatus(); // モーダルの状態を更新

            } catch (e) {
                console.error("Failed to delete payment method locally:", e);
                showMessage(`エラー: 支払い方法の削除に失敗しました`);
            }
        };
        
        // --- 電卓ロジック (Calculatorタブ) ---
        let currentDisplay = '0';
        let firstOperand = null;
        let operator = null;
        let waitingForSecondOperand = false;

        const updateCalcDisplay = () => {
            const displayElement = document.getElementById('calc-display');
            displayElement.textContent = currentDisplay;
        };

        const formatCalcValue = (value) => {
            const num = parseFloat(value);
            if (isNaN(num)) return 'Error';
            // 小数点以下が0の場合は整数として表示
            if (num.toString().includes('e') || Math.abs(num) > 999999999) return num.toExponential(3);
            if (num.toString().split('.')[1]?.length > 10) return num.toFixed(10).replace(/0+$/, '');
            return num.toString();
        }

        const calcAction = (type, value) => {
            switch(type) {
                case 'clear':
                    currentDisplay = '0';
                    firstOperand = null;
                    operator = null;
                    waitingForSecondOperand = false;
                    break;
                case 'digit':
                    if (waitingForSecondOperand) {
                        currentDisplay = value;
                        waitingForSecondOperand = false;
                    } else if (currentDisplay === '0') {
                        currentDisplay = value;
                    } else {
                        currentDisplay += value;
                    }
                    break;
                case 'decimal':
                    if (waitingForSecondOperand) {
                        currentDisplay = '0.';
                        waitingForSecondOperand = false;
                    } else if (!currentDisplay.includes('.')) {
                        currentDisplay += '.';
                    }
                    break;
                case 'toggleSign':
                    currentDisplay = formatCalcValue(-parseFloat(currentDisplay));
                    break;
                case 'operator':
                    handleOperator(value);
                    break;
                case 'calculate':
                    handleOperator(value);
                    break;
            }
            updateCalcDisplay();
        };

        const handleOperator = (nextOperator) => {
            const inputValue = parseFloat(currentDisplay);
            
            if (operator && !waitingForSecondOperand) {
                performCalculation(inputValue);
                currentDisplay = formatCalcValue(firstOperand);
            }
            
            if (firstOperand === null) {
                firstOperand = inputValue;
            }
            
            waitingForSecondOperand = true;
            operator = nextOperator === '=' ? null : nextOperator;
        };
        
        const performCalculation = (secondOperand) => {
            const op1 = firstOperand;
            const op2 = secondOperand;
            
            if (operator === '+') { firstOperand = op1 + op2; }
            else if (operator === '-') { firstOperand = op1 - op2; }
            else if (operator === '*') { firstOperand = op1 * op2; }
            else if (operator === '/') { 
                if (op2 === 0) {
                    currentDisplay = 'Error';
                    firstOperand = null;
                    operator = null;
                    return;
                }
                firstOperand = op1 / op2; 
            }
            else if (operator === '%') { firstOperand = op1 % op2; }
        };

        // --- 初期化ロジック (正しいバージョンを関数の定義として配置) ---
        
        window.fetchData = () => {
            // 1. メニューアイテム
            window.inventory = loadFromLocalStorage(LS_KEYS.MENU, []);
            if (window.inventory.length === 0) {
                window.inventory = [
                    { docId: generateId(), name: "クレープ", price: 300, isHidden: false },
                    { docId: generateId(), name: "サイダー", price: 250, isHidden: false },
                    { docId: generateId(), name: "アイス", price: 450, isHidden: false }
                ];
                saveToLocalStorage(LS_KEYS.MENU, window.inventory);
            }
            
            // 2. 支払い方法
            window.paymentMethods = loadFromLocalStorage(LS_KEYS.PAYMENT, ["現金", "二次元コード決済", "クレジットカード"]);
            
            // 描画をトリガー
            window.renderMenu();
            window.renderEditList();
            window.renderPaymentEditSection();
            document.getElementById('status-message').textContent = 'ローカルストレージで動作中 (準備完了)';
        };

        const setupListeners = () => {
            window.fetchData(); 
            updateCart();
        };

        window.addEventListener('load', setupListeners); // 修正: ロード時に setupListeners を実行
        
        // グローバルに公開
        window.switchTab = switchTab;
        window.addToCart = addToCart;
        window.updateQuantity = updateQuantity;
        window.clearCart = clearCart;
        window.showPaymentModal = showPaymentModal;
        window.hidePaymentModal = hidePaymentModal;
        window.processPayment = processPayment;
        window.renderHistoryList = renderHistoryList;
        window.updateChange = updateChange;
        window.updatePaymentStatus = updatePaymentStatus;
        window.addNewItem = addNewItem;
        window.updateItem = updateItem;
        window.toggleItemVisibility = toggleItemVisibility;
        window.deleteItem = deleteItem;
        window.addPaymentMethod = addPaymentMethod;
        window.deletePaymentMethod = deletePaymentMethod;
        window.calcAction = calcAction;
        window.renderPaymentEditSection = renderPaymentEditSection;
        window.confirmResetHistory = confirmResetHistory;
        window.resetHistory = resetHistory;
        window.showItemStatsModal = showItemStatsModal;
        window.hideItemStatsModal = hideItemStatsModal;
        window.updateCart = updateCart;
        window.confirmResetOthersResetHistory = confirmResetOthersResetHistory;
        window.resetOthersResetHistory = resetOthersResetHistory;
    </script>
</body>
</html>
